name: CI - Pull Request

on:
  pull_request:
    branches: [main]
  push:
    branches-ignore: [main]  # Run on feature branches

permissions:
  contents: read
  pull-requests: write

jobs:
  # ============================================================================
  # Validation - Must pass before merge
  # ============================================================================
  validate:
    name: Validation on ${{ matrix.os }} - Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.11', '3.12']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: Syntax validation
      run: |
        python -m py_compile duckdice.py
        python -m py_compile duckdice_cli.py
        python -m py_compile duckdice_tui.py
    
    - name: Import validation
      run: |
        python -c "import sys; sys.path.insert(0, 'src'); from betbot_strategies import list_strategies; strategies = list_strategies(); print(f'✓ Found {len(strategies)} strategies'); assert len(strategies) >= 18, 'Missing strategies'"
    
    - name: Run test suite
      run: |
        pytest tests/ -v --tb=short --cov=src --cov-report=term-missing
    
    - name: Package build test
      run: |
        pip install -e .
        python -c "import duckdice_cli; print('✓ Package imports successfully')"
    
    - name: CLI functionality test
      run: |
        python duckdice_cli.py --help
        python duckdice_cli.py strategies
      shell: bash
  
  # ============================================================================
  # Code Quality Checks
  # ============================================================================
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Check for forbidden patterns
      run: |
        echo "Checking for legacy files..."
        if find . -type f \( -name "*.bak" -o -name "*.old" -o -name "*_deprecated.*" \) | grep -v venv | grep -q .; then
          echo "❌ Found legacy files (.bak, .old, _deprecated)"
          exit 1
        fi
        
        echo "Checking for archive directories..."
        if find . -type d \( -name "archive" -o -name "old" -o -name "legacy" \) | grep -v venv | grep -q .; then
          echo "❌ Found archive directories"
          exit 1
        fi
        
        echo "✓ Repository is clean"
    
    - name: Check core decoupling
      run: |
        echo "Checking core has no UI imports..."
        
        # Check betbot_engine
        if grep -r "from rich\|from textual\|import tkinter\|from nicegui" src/betbot_engine/ 2>/dev/null; then
          echo "❌ UI imports found in betbot_engine"
          exit 1
        fi
        
        # Check betbot_strategies
        if grep -r "from rich\|from textual\|import tkinter\|from nicegui" src/betbot_strategies/ 2>/dev/null; then
          echo "❌ UI imports found in betbot_strategies"
          exit 1
        fi
        
        # Check duckdice_api
        if grep -r "from rich\|from textual\|import tkinter\|from nicegui" src/duckdice_api/ 2>/dev/null; then
          echo "❌ UI imports found in duckdice_api"
          exit 1
        fi
        
        echo "✓ Core is decoupled from UI"
  
  # ============================================================================
  # PR Status Summary
  # ============================================================================
  pr-summary:
    name: PR Validation Summary
    runs-on: ubuntu-latest
    needs: [validate, quality]
    if: always()
    
    steps:
    - name: Check results
      run: |
        if [ "${{ needs.validate.result }}" != "success" ] || [ "${{ needs.quality.result }}" != "success" ]; then
          echo "❌ PR validation failed"
          echo "Validation: ${{ needs.validate.result }}"
          echo "Quality: ${{ needs.quality.result }}"
          exit 1
        else
          echo "✅ All checks passed - safe to merge"
        fi
