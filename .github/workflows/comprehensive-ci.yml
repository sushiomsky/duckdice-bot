name: Comprehensive CI/CD

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install linting tools
        run: |
          pip install pylint flake8 black isort mypy
      
      - name: Check code formatting (black)
        run: black --check src/ tests/ || true
        continue-on-error: true
      
      - name: Check import sorting (isort)
        run: isort --check-only src/ tests/ || true
        continue-on-error: true
      
      - name: Run flake8
        run: flake8 src/ --max-line-length=120 --extend-ignore=E203,W503 || true
        continue-on-error: true
      
      - name: Run pylint
        run: pylint src/ --exit-zero --max-line-length=120

  test:
    name: Test - Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']
        exclude:
          # Reduce matrix for non-critical combinations
          - os: macos-latest
            python-version: '3.10'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-cov pytest-xdist
      
      - name: Run tests
        run: |
          pytest tests/ -v --tb=short -m "not slow and not api" --cov=src --cov-report=xml --cov-report=term
      
      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  build-artifacts:
    name: Build Distribution Artifacts
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install build tools
        run: |
          pip install build twine
      
      - name: Build distributions
        run: python -m build
      
      - name: Check distributions
        run: twine check dist/*
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-distributions
          path: dist/
          retention-days: 30

  build-executables:
    name: Build ${{ matrix.os }} Executable
    runs-on: ${{ matrix.os }}
    needs: [test]
    strategy:
      matrix:
        include:
          - os: windows-latest
            artifact_name: DuckDiceBot-Windows-x64
            artifact_file: DuckDiceBot-Windows-x64.zip
          - os: macos-latest
            artifact_name: DuckDiceBot-macOS
            artifact_file: DuckDiceBot-macOS-universal.zip
          - os: ubuntu-latest
            artifact_name: DuckDiceBot-Linux-x64
            artifact_file: DuckDiceBot-Linux-x64.tar.gz
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Build executable
        shell: bash
        run: |
          pyinstaller --clean duckdice_gui_ultimate.spec
      
      - name: Package Windows
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Compress-Archive -Path "dist/DuckDiceBot.exe","README.md","LICENSE" -DestinationPath "${{ matrix.artifact_file }}"
      
      - name: Package macOS
        if: matrix.os == 'macos-latest'
        run: |
          cd dist
          if [ -d "DuckDiceBot.app" ]; then
            zip -r ../${{ matrix.artifact_file }} DuckDiceBot.app
          else
            zip ../${{ matrix.artifact_file }} DuckDiceBot
          fi
      
      - name: Package Linux
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd dist
          tar -czf ../${{ matrix.artifact_file }} DuckDiceBot
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_file }}
          retention-days: 30

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-artifacts, build-executables]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Generate changelog
        id: changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
            awk '/^## \[${{ steps.version.outputs.VERSION }}\]/{flag=1;next}/^## \[/{flag=0}flag' CHANGELOG.md >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "CHANGELOG=See commits for changes" >> $GITHUB_OUTPUT
          fi
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/DuckDiceBot-Windows-x64/*.zip
            artifacts/DuckDiceBot-macOS/*.zip
            artifacts/DuckDiceBot-Linux-x64/*.tar.gz
            artifacts/python-distributions/*.whl
            artifacts/python-distributions/*.tar.gz
          body: |
            # DuckDice Bot v${{ steps.version.outputs.VERSION }}
            
            ## ðŸ“¦ Downloads
            
            **Executables:**
            - Windows: `DuckDiceBot-Windows-x64.zip`
            - macOS: `DuckDiceBot-macOS-universal.zip`
            - Linux: `DuckDiceBot-Linux-x64.tar.gz`
            
            **Python Package:**
            - Install via pip: `pip install duckdice-betbot==${{ steps.version.outputs.VERSION }}`
            
            ## ðŸ“‹ Changelog
            
            ${{ steps.changelog.outputs.CHANGELOG }}
            
            ## ðŸš€ Quick Start
            
            ```bash
            # From executable: extract and run
            # From pip:
            pip install duckdice-betbot==${{ steps.version.outputs.VERSION }}
            duckdice --help
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Publish to PyPI
        if: ${{ secrets.PYPI_API_TOKEN }}
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          pip install twine
          twine upload artifacts/python-distributions/*
